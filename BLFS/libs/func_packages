#!/bin/bash
#
# $Id$
#
set -e

#-----------------------#
generate_packages()  {  # Master packages file
#-----------------------#
  local pkg_id file

  > packages.tmp

  # Extract Id and path for sect1 files
  for file in `find $BLFS_XML -name "*.xml"` ; do
    pkg_id=`grep "sect1 id" $file | sed -e 's/<sect1 id="//;s/".*//'`
    [[ ! -z "$pkg_id" ]] && echo -e "$pkg_id\t$file" >> packages.tmp
  done

  # IDs clean-up (unuseful pages or commented-out packages, could be more)
  sed -i '/template/d;/ntroduction/d;/preface/d;/alsa.xml/d' packages.tmp
  sed -i '/obsolete/d;/postlfs-/d;/-client.xml/d;/xorg7.xml/d' packages.tmp
  sed -i '/courier.xml/d;/-other\t/d;/others-/d;/other-/d' packages.tmp
  sed -i '/fw-firewall/d;/gcc2/d;/cvsserver/d;/svnserver/d' packages.tmp

  # Add header with meta-packages pseudo Id
{
  cat << EOF
alsa	$BLFS_XML
gnome-core	$BLFS_XML
gnome-full	$BLFS_XML
kde-core	$BLFS_XML
kde-full	$BLFS_XML
kde-koffice	$BLFS_XML
xorg7	$BLFS_XML
EOF
} >> packages.tmp

  # Dump packages list
  sort packages.tmp -b --key=2 --field-separator=/ --output=packages

  # Clean up
  rm packages.tmp
}

# Pre-made *.dep files for meta-packages

#--------------------------#
generate_gnome_core()  {   # GNOME core
#--------------------------#
  local line base_xml package

  > gnome-core.dep.tmp

  for line in `grep "xi:include" $BLFS_XML/gnome/core/core.xml` ; do
    base_xml=`echo $line | sed 's/^.*href="//;s/".*//'`
    package=`grep "gnome/core/$base_xml" packages | cut -f1`
    [[ -n "$package" ]] && echo $package >> gnome-core.dep.tmp
  done

  tac gnome-core.dep.tmp > libs/gnome-core.dep
  rm gnome-core.dep.tmp
}

#--------------------------#
generate_gnome_full()  {   # GNOME full
#--------------------------#
  local line base_xml package

  echo "gnome-core" > gnome-full.dep.tmp

  for line in `grep "xi:include" $BLFS_XML/gnome/add/add.xml` ; do
    base_xml=`echo $line | sed 's/^.*href="//;s/".*//'`
    package=`grep "gnome/add/$base_xml" packages | cut -f1`
    [[ -n "$package" ]] && echo $package >> gnome-full.dep.tmp
  done

  tac gnome-full.dep.tmp > libs/gnome-full.dep
  rm gnome-full.dep.tmp
}

#--------------------------#
generate_kde_core()  {     # KDE core
#--------------------------#
  local line base_xml package

  > kde-core.dep.tmp

  for line in `grep "xi:include" $BLFS_XML/kde/core/core.xml` ; do
    base_xml=`echo $line | sed 's/^.*href="//;s/".*//'`
    package=`grep "kde/core/$base_xml" packages | cut -f1`
    [[ -n "$package" ]] && echo $package >> kde-core.dep.tmp
  done

  tac kde-core.dep.tmp > libs/kde-core.dep
  rm kde-core.dep.tmp
}

#--------------------------#
generate_kde_full()  {     # KDE full
#--------------------------#
  local line base_xml package

  echo "kde-core" > kde-full.dep.tmp

  for line in `grep "xi:include" $BLFS_XML/kde/add/add.xml` ; do
    base_xml=`echo $line | sed 's/^.*href="//;s/".*//'`
    package=`grep "kde/add/$base_xml" packages | cut -f1`
    [[ -n "$package" ]] && echo $package >> kde-full.dep.tmp
  done

  for line in `grep "xi:include" $BLFS_XML/kde/devel/devel.xml` ; do
    base_xml=`echo $line | sed 's/^.*href="//;s/".*//'`
    package=`grep "kde/devel/$base_xml" packages | cut -f1`
    [[ -n "$package" ]] && echo $package >> kde-full.dep.tmp
  done

  tac kde-full.dep.tmp > libs/kde-full.dep
  rm kde-full.dep.tmp
}

#--------------------------#
generate_kde_koffice()  {  # KDE full + Koffice
#--------------------------#
  echo -e "koffice\nkde-full\nkde-core" > libs/kde-koffice.dep
}

#--------------------------#
generate_alsa()  {         # ALSA packages
#--------------------------#
  echo -e "alsa-oss\nalsa-firmware\nalsa-tools\nalsa-utils\n\
alsa-plugins\nalsa-lib" > libs/alsa.dep
}

#--------------------------#
generate_xorg7()  {        # Xorg7 packages
#--------------------------#
  echo -e "x-config\nx-setup\nrman\nxterm2\nxorg7-driver\nxorg7-server\nluit\n\
xorg7-font\nxorg7-data\nxorg7-app\nxbitmaps\nmesalib\nlibdrm\n\
xorg7-lib\nxorg7-util\nxorg7-proto" > libs/xorg7.dep
}
